{"id":"oh-my-opencode-a9a","title":"Toast not appearing on startup - TUI timing issue","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-20T07:52:38.578228-06:00","updated_at":"2025-12-20T07:52:47.913252-06:00","closed_at":"2025-12-20T07:52:47.913252-06:00","close_reason":"FIXED: session.created fires before TUI is ready. Solution: delay toast by 1500ms in setTimeout. File: src/hooks/auto-update-checker/index.ts. Commit: b3842e4"}
{"id":"oh-my-opencode-n8k","title":"Modularize THINK.ALIGN.ACT paradigm + custom build indicators","description":"Extract THINK.ALIGN.ACT philosophy into maintainable module, add clear custom build indicators throughout the codebase to distinguish from upstream npm release.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-20T05:55:35.239809-06:00","updated_at":"2025-12-20T06:03:24.660951-06:00","closed_at":"2025-12-20T06:03:24.660951-06:00","close_reason":"All subtasks completed: paradigm modularized, package renamed, startup toast updated, AGENTS.md documented"}
{"id":"oh-my-opencode-n8k.1","title":"Create src/agents/paradigm/think-align-act.ts with extracted philosophy sections","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T05:55:35.326735-06:00","updated_at":"2025-12-20T06:00:05.334384-06:00","closed_at":"2025-12-20T06:00:05.334384-06:00","close_reason":"Created paradigm module at src/agents/paradigm/think-align-act.ts","dependencies":[{"issue_id":"oh-my-opencode-n8k.1","depends_on_id":"oh-my-opencode-n8k","type":"parent-child","created_at":"2025-12-20T05:55:35.327441-06:00","created_by":"daemon"}]}
{"id":"oh-my-opencode-n8k.2","title":"Refactor sisyphus.ts to import and compose paradigm module","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T05:55:35.413673-06:00","updated_at":"2025-12-20T06:00:06.265133-06:00","closed_at":"2025-12-20T06:00:06.265133-06:00","close_reason":"Refactored sisyphus.ts to import and compose from paradigm module","dependencies":[{"issue_id":"oh-my-opencode-n8k.2","depends_on_id":"oh-my-opencode-n8k","type":"parent-child","created_at":"2025-12-20T05:55:35.414058-06:00","created_by":"daemon"}]}
{"id":"oh-my-opencode-n8k.3","title":"Update package.json with custom name and local build scripts","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T05:55:35.502088-06:00","updated_at":"2025-12-20T06:01:04.92516-06:00","closed_at":"2025-12-20T06:01:04.92516-06:00","close_reason":"Updated package.json with @carmandale scope, custom version suffix, local:install and local:use scripts","dependencies":[{"issue_id":"oh-my-opencode-n8k.3","depends_on_id":"oh-my-opencode-n8k","type":"parent-child","created_at":"2025-12-20T05:55:35.502534-06:00","created_by":"daemon"}]}
{"id":"oh-my-opencode-n8k.4","title":"Update startup toast to show CUSTOM BUILD indicator","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T05:55:35.588379-06:00","updated_at":"2025-12-20T06:01:53.457241-06:00","closed_at":"2025-12-20T06:01:53.457241-06:00","close_reason":"Updated startup toast to show [CUSTOM BUILD] tag and @carmandale scope","dependencies":[{"issue_id":"oh-my-opencode-n8k.4","depends_on_id":"oh-my-opencode-n8k","type":"parent-child","created_at":"2025-12-20T05:55:35.588766-06:00","created_by":"daemon"}]}
{"id":"oh-my-opencode-n8k.5","title":"Update AGENTS.md with custom build documentation","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T05:55:35.675253-06:00","updated_at":"2025-12-20T06:03:23.601905-06:00","closed_at":"2025-12-20T06:03:23.601905-06:00","close_reason":"Updated AGENTS.md with custom fork notice, paradigm location, build instructions, and merge strategy","dependencies":[{"issue_id":"oh-my-opencode-n8k.5","depends_on_id":"oh-my-opencode-n8k","type":"parent-child","created_at":"2025-12-20T05:55:35.67567-06:00","created_by":"daemon"}]}
{"id":"oh-my-opencode-rso","title":"Preemptive compaction fails ~60% - race condition in token checking","description":"## Problem\n\nSessions frequently hit \"prompt is too long: 206228 tokens \u003e 200000 maximum\" despite having `preemptive_compaction: true` and `preemptive_compaction_threshold: 0.7` configured. This completely destroys the session with no recovery possible.\n\nFailure rate: ~60% of sessions, especially swarm workers.\n\n## Root Cause Analysis\n\n### 1. Post-hoc checking (fundamental race condition)\n\nThe preemptive compaction hook only checks AFTER an assistant message completes (`message.updated` event) or on `session.idle`. \n\n```typescript\n// preemptive-compaction/index.ts lines 103-122\nconst tokens = lastAssistant.tokens\nif (!tokens) return  // No tokens = no compaction\n\nconst totalUsed = tokens.input + tokens.cache.read + tokens.output\nconst usageRatio = totalUsed / contextLimit\n\nif (usageRatio \u003c threshold) return  // Only triggers if ABOVE threshold\n```\n\nIf a single message pushes context from 65% → 103%, the check happens too late - the API has already rejected the request.\n\n### 2. No pre-flight check\n\nThere is no mechanism to check context BEFORE sending a prompt. The API rejects with \"prompt is too long\" before any hook can intervene.\n\n### 3. Large tool outputs cause sudden spikes\n\nSwarm sessions do many operations (git push, bd sync, git status). A single verbose command can add 10-20K tokens instantly, jumping from safe to overflow.\n\n### 4. Cooldown prevents rapid re-compaction\n\n`COMPACTION_COOLDOWN_MS = 60_000` (1 minute). If you hit 70%, compact, then rapidly accumulate again, you cannot compact for 60 seconds.\n\n### 5. Minimum threshold blocks early compaction\n\n`MIN_TOKENS_FOR_COMPACTION = 50_000`. Sessions under 50K tokens will not trigger compaction even at 70%.\n\n## The Fatal Sequence\n\n```\nSession at 65% (130K tokens)\n↓\nAgent runs: git push, bd sync, git status (adds 40K tokens)\n↓\nAPI receives 170K tokens → REJECTS with \"206K \u003e 200K maximum\"\n↓\npreemptive-compaction hook never fires (message never completed)\n↓\nanthropic-auto-compact tries to recover but session is already dead\n```\n\n## Why Swarm Workers Are Especially Vulnerable\n\n- Do many sequential operations (reserve → edit → test → commit → push → sync)\n- Each operation adds tool output to context\n- Often run close to the wire on complex tasks\n- No visibility into accumulated context until it is too late\n\n## Proposed Solutions\n\n### Option A: Pre-prompt context estimation\nBefore sending any prompt, estimate if adding it will exceed the limit. Compact preemptively if projected usage \u003e threshold.\n\n### Option B: Lower threshold + remove cooldown for critical situations\n- Lower default threshold to 60% \n- Remove or reduce cooldown when approaching danger zone (\u003e80%)\n- Allow emergency compaction even during cooldown if \u003e90%\n\n### Option C: Tool output budgeting\n- Track cumulative tool output size per session\n- Truncate aggressively when approaching limits\n- Use --quiet flags automatically for git/bd commands\n\n### Option D: Pre-send hook\nAdd a beforePromptSend hook that can intercept and compact before the API call is made.\n\n## Environment\n\n- oh-my-opencode config: preemptive_compaction: true, preemptive_compaction_threshold: 0.7\n- Model: claude-sonnet-4-5 (200K context limit)\n- Affected: Swarm workers, long-running sessions\n\n## Files Involved\n\n- src/hooks/preemptive-compaction/index.ts - main hook logic\n- src/hooks/preemptive-compaction/constants.ts - thresholds (DEFAULT_THRESHOLD=0.85, MIN_TOKENS=50K, COOLDOWN=60s)\n- src/hooks/anthropic-auto-compact/index.ts - reactive recovery (too late)\n- src/hooks/anthropic-auto-compact/executor.ts - truncation/revert logic","status":"open","priority":0,"issue_type":"bug","created_at":"2025-12-21T14:33:13.78508-06:00","updated_at":"2025-12-21T14:33:38.520815-06:00"}
